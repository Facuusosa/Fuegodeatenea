{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}Cat√°logo de Sahumerios - Fuego de Atenea{% endblock %}
{% block body_class %}page-catalog{% endblock %}

{% block styles %}
<style>
/* Use site mystic theme variables for consistency */
:root {
    --bg-primary: var(--mystic-cream);
    --bg-secondary: rgba(255,255,255,0.7);
    --bg-card: rgba(255,255,255,0.9);
    --bg-card-hover: rgba(255,255,255,1);
    --text-primary: var(--mystic-text);
    --text-secondary: color-mix(in srgb, var(--mystic-text) 80%, black 0%);
    --text-muted: rgba(61,55,49,0.7);
    --accent: var(--mystic-gold);
    --accent-hover: var(--mystic-gold-light);
    --border: rgba(201, 169, 97, 0.25);
    --border-hover: rgba(201, 169, 97, 0.45);
    --shadow-sm: 0 2px 8px rgba(201, 169, 97, 0.12);
    --shadow-md: 0 6px 18px rgba(201, 169, 97, 0.18);
    --shadow-lg: 0 10px 36px rgba(201, 169, 97, 0.22);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
.page-catalog { 
  background: var(--bg-primary); 
  color: var(--text-primary); 
  line-height: 1.6; 
  min-height: 100vh;
  isolation: auto;
  position: relative;
  z-index: 1;
}

/* Typography */
.catalog-header { text-align: center; margin: 0 auto 48px; max-width: 880px; padding: 24px; }
.catalog-title { font-size: clamp(2rem, 5vw, 3rem); font-weight: 400; color: var(--accent); margin-bottom: 12px; letter-spacing: -0.02em; }
.catalog-subtitle { font-size: 1rem; font-weight: 300; color: var(--text-secondary); letter-spacing: 0.01em; }

/* Buttons (scoped) */
.page-catalog .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 24px; font-size:.9rem; font-weight:500; text-decoration:none; border:1px solid var(--border); border-radius:8px; background:transparent; color:var(--text-primary); cursor:pointer; transition:all .2s ease; letter-spacing:.02em; }
.page-catalog .btn:hover { background:var(--bg-card); border-color:var(--accent); color:var(--accent); }
.page-catalog .btn-primary { background:var(--accent); color:#fff; border-color:var(--accent); }
.page-catalog .btn-primary:hover { background:var(--accent-hover); border-color:var(--accent-hover); color:#fff; box-shadow:0 6px 16px rgba(201,169,97,.28); }
.page-catalog .btn-danger { border-color:#d4756a; color:#d4756a; }
.page-catalog .btn-danger:hover { background:#d4756a; color:#fff; }

/* Grid */
.products-grid { 
  display:grid; 
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 28px; 
  padding: 0 8px; 
  max-width: 1400px; 
  margin: 0 auto;
  position: relative;
  z-index: 1;
  isolation: isolate;
}

/* Product Cards */
.product-card { 
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  border-radius: 10px; 
  transition: all .25s ease; 
  position: relative; 
  overflow: hidden; 
  display:flex; 
  flex-direction:column;
  z-index: 2;
}
.product-card:hover { 
  border-color: var(--accent); 
  box-shadow: var(--shadow-md); 
  transform: translateY(-2px);
  z-index: 3;
}

/* PRODUCTOS SIN STOCK - Estilos mejorados */
.product-card.out-of-stock {
  opacity: 0.65;
  background: rgba(245, 245, 245, 0.8);
  border-color: rgba(150, 150, 150, 0.3);
}

.product-card.out-of-stock .product-image {
  position: relative;
}

.product-card.out-of-stock .product-image::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.5);
  pointer-events: none;
}

.product-card.out-of-stock .product-image img {
  filter: grayscale(100%) brightness(1.2);
  opacity: 0.6;
}

.product-card.out-of-stock:hover {
  transform: none;
  box-shadow: var(--shadow-sm);
  border-color: rgba(150, 150, 150, 0.3);
}

.product-card.out-of-stock .product-title a {
  color: var(--text-muted);
}

.product-card.out-of-stock .current-price {
  color: var(--text-muted);
  text-decoration: line-through;
}

/* Badges */
.product-badges { position:absolute; top:12px; left:12px; z-index:2; display:flex; flex-direction:column; gap:8px; }
.badge { padding: 6px 12px; font-size: .7rem; font-weight: 500; text-transform: uppercase; letter-spacing: .08em; background: rgba(255,255,255,.95); color: var(--text-primary); border: 1px solid var(--border); backdrop-filter: blur(8px); border-radius: 4px; }
.badge-best-seller { background: var(--accent); color: #fff; border-color: var(--accent); }
.badge-new { background: rgba(255,255,255,.95); color: var(--accent); border-color: var(--accent); }
.badge-import { background: rgba(255,255,255,.95); color: var(--text-secondary); border-color: var(--border-hover); }
.badge-out-of-stock { background: rgba(128, 128, 128, 0.95); color: #fff; border-color: #808080; font-weight: 600; }

/* Image */
.product-image { position: relative; height: 300px; background: var(--bg-secondary); overflow: hidden; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--border); }
.product-image img { width: 100%; height: 100%; object-fit: contain; padding: 28px; transition: transform .35s ease, opacity .25s ease; }
.product-card:not(.out-of-stock):hover .product-image img { transform: scale(1.03); }

/* Actions */
.product-actions { position:absolute; top:12px; right:12px; display:flex; flex-direction:column; gap:8px; opacity:0; transform: translateX(8px); transition: all .25s ease; z-index: 3; }
.product-card:not(.out-of-stock):hover .product-actions { opacity:1; transform: translateX(0); }
.action-btn { width:38px; height:38px; border:1px solid var(--border); background: rgba(255,255,255,.95); color: var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .2s ease; backdrop-filter: blur(8px); border-radius: 6px; }
.action-btn:hover { background: var(--bg-card-hover); border-color: var(--accent); }

/* Info */
.product-info { padding: 18px; flex-grow: 1; display:flex; flex-direction:column; }
.product-title { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); margin-bottom: 6px; letter-spacing: -0.01em; }
.product-title a { color: inherit; text-decoration: none; }
.product-title a:hover { color: var(--accent); }
.product-brand { font-size:.8rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .05em; }
.product-description { font-size:.9rem; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; line-clamp:2; -webkit-box-orient: vertical; }

/* Price */
.product-price { display:flex; align-items:baseline; gap: 12px; margin-top:auto; padding-top: 12px; border-top:1px solid var(--border); margin-bottom: 12px; }
.current-price { font-size: 1.4rem; font-weight: 700; color: var(--accent); letter-spacing: -0.02em; }
.old-price { font-size: .9rem; color: var(--text-muted); text-decoration: line-through; }
.discount-badge { font-size: .75rem; color: var(--text-secondary); font-weight: 600; letter-spacing: .02em; }

/* Quantity */
.quantity-selector { display:flex; align-items:center; gap:0; margin-bottom: 12px; border:1px solid var(--border); width:fit-content; border-radius:6px; overflow:hidden; }
.qty-btn { width:36px; height:36px; border:none; background: transparent; color: var(--accent); display:flex; align-items:center; justify-content:center; cursor:pointer; transition: all .2s ease; font-size: 1rem; }
.qty-btn:hover { background: var(--bg-card-hover); color: var(--accent-hover); }
.qty-btn:first-child { border-right:1px solid var(--border); }
.qty-btn:last-child { border-left:1px solid var(--border); }
.qty-input { width: 52px; height:36px; border:none; background:transparent; color: var(--text-primary); text-align:center; font-weight:600; font-size:.95rem; }
.qty-input:focus { outline:none; }

/* Mensaje de sin stock mejorado */
.out-of-stock-message {
  text-align: center;
  padding: 14px;
  background: rgba(128, 128, 128, 0.08);
  border: 1px solid rgba(128, 128, 128, 0.2);
  border-radius: 6px;
  color: #666;
  font-size: 0.9rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}

/* Edit Mode */
.edit-mode-banner { 
  background: var(--bg-card); 
  border:1px solid var(--border); 
  padding: 18px; 
  margin: 0 8px 28px; 
  max-width: 1400px; 
  margin-left:auto; 
  margin-right:auto; 
  display:flex; 
  align-items:center; 
  justify-content:space-between; 
  flex-wrap:wrap; 
  gap: 12px; 
  border-radius: 10px;
  position: relative;
  z-index: 2;
}
.edit-actions { display:flex; gap: 10px; flex-wrap: wrap; }

/* Forms */
.cart-form { display:flex; flex-direction:column; }
.add-to-cart-btn { width: 100%; }

/* Responsive */
@media (max-width: 768px) {
  .products-grid { grid-template-columns: 1fr; gap: 20px; padding: 0; }
  .catalog-header { padding: 20px; margin-bottom: 36px; }
  .product-image { height: 240px; }
  .edit-mode-banner { flex-direction: column; align-items: flex-start; }
  .edit-actions { width: 100%; }
  .edit-actions .btn { flex: 1; }
}

@media (max-width: 480px) {
  .product-image { height: 220px; }
  .product-info { padding: 16px; }
}
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
    <h1 class="catalog-title">Colecci√≥n de Sahumerios</h1>
    <p class="catalog-subtitle">Fragancias artesanales y ediciones especiales</p>
  </div>

  {% if edit_mode %}
  <div class="edit-mode-banner">
    <div>
      <strong>Modo edici√≥n activado</strong>
      <p style="margin:4px 0 0; font-size:.9rem; color: var(--text-secondary);">Pod√©s agregar, editar o eliminar productos</p>
    </div>
    <div class="edit-actions">
      <a href="{% url 'sahumerios_lista' %}" class="btn">Salir</a>
      <a href="{% url 'sahumerio_nuevo' %}" class="btn btn-primary">Crear producto</a>
    </div>
  </div>
  {% endif %}

  <div class="products-grid">
    {% for it in items %}
      {% comment %}Detectar si el producto est√° sin stock o inactivo{% endcomment %}
      {% if it.stock == 0 or it.stock == "0" or it.stock == None or it.activo == "NO" or it.activo == "no" or it.activo == False %}
      <article class="product-card out-of-stock" data-product-id="{{ it.pk|default:it.idx }}" data-product-origin="{{ it.origen }}">
      {% else %}
      <article class="product-card" data-product-id="{{ it.pk|default:it.idx }}" data-product-origin="{{ it.origen }}">
      {% endif %}
      
        {% if it.origen == 'DB' and it.pk %}
          {% url 'sahumerio_detalle' it.pk as detail_url %}
        {% elif it.match_id %}
          {% url 'sahumerio_detalle' it.match_id as detail_url %}
        {% else %}
          {% url 'excel_detalle' it.idx as detail_url %}
        {% endif %}

        <div class="product-badges">
          {% if it.stock == 0 or it.stock == "0" or it.stock == None or it.stock == '' or it.activo == "NO" or it.activo == "no" or it.activo == False %}
          <span class="badge badge-out-of-stock">Sin Stock</span>
          {% else %}
            {% if forloop.counter <= 3 %}
            <span class="badge badge-best-seller">Favorito</span>
            {% endif %}

            {% if not it.match_id %}
              {% if it.origen != 'DB' or not it.pk %}
            <span class="badge badge-import">Destacado</span>
              {% endif %}
            {% endif %}

            {% if forloop.counter|divisibleby:5 %}
            <span class="badge badge-new">Nuevo</span>
            {% endif %}
          {% endif %}
        </div>

        <div class="product-image">
          <a href="{{ detail_url }}">
            {# ‚ú® CORRECCI√ìN: Usar img_url construida en la vista #}
            <img src="{{ it.img_url }}" alt="{{ it.titulo }}" loading="lazy" decoding="async">
          </a>

          {% comment %}Solo mostrar acciones si tiene stock{% endcomment %}
          {% if it.stock != 0 and it.stock != "0" and it.stock != None and it.activo != "NO" and it.activo != "no" and it.activo != False %}
          <div class="product-actions">
            <button class="action-btn" type="button" title="Vista r√°pida">üëÅÔ∏è</button>
            <button class="action-btn" type="button" title="Favorito">‚ù§</button>
          </div>
          {% endif %}
        </div>

        <div class="product-info">
          <h3 class="product-title">
            <a href="{{ detail_url }}">{{ it.titulo }}</a>
          </h3>

          {% if it.marca %}
          <p class="product-brand">{{ it.marca }}</p>
          {% endif %}

          {% if it.descripcion %}
          <p class="product-description">{{ it.descripcion }}</p>
          {% endif %}

          <div class="product-price">
            <span class="current-price">$ {{ it.precio|floatformat:2|intcomma }}</span>
            {% if forloop.counter|divisibleby:4 %}
              {% if it.stock != 0 and it.stock != "0" and it.stock != None and it.activo != "NO" and it.activo != "no" and it.activo != False %}
            <span class="old-price">$ {{ it.precio|add:500|floatformat:2|intcomma }}</span>
            <span class="discount-badge">-15%</span>
              {% endif %}
            {% endif %}
          </div>

          {% if edit_mode %}
          <div class="edit-actions" style="margin-bottom: 12px;">
            {% if it.origen == 'DB' and it.pk %}
              <a href="{% url 'sahumerio_editar' it.pk %}?volver={{ request.get_full_path|urlencode }}" class="btn">Editar</a>
              <form method="post" action="{% url 'sahumerio_borrar' it.pk %}" onsubmit="return confirm('¬øBorrar este producto?')" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Borrar</button>
              </form>
            {% else %}
              <a href="{% url 'sahumerio_nuevo' %}?sug_marca={{ it.marca|urlencode }}&sug_nombre={{ it.titulo|urlencode }}&sug_descripcion={{ it.descripcion|urlencode }}&sug_precio={{ it.precio|urlencode }}&sug_imagen_url={{ it.img_abs|urlencode }}&sug_imagen_file={{ it.img_file|urlencode }}" class="btn btn-primary">Crear en DB</a>
            {% endif %}
          </div>
          {% endif %}

          {% comment %}MENSAJE O FORMULARIO seg√∫n stock{% endcomment %}
          {% if it.stock == 0 or it.stock == "0" or it.stock == None or it.activo == "NO" or it.activo == "no" or it.activo == False %}
            <div class="out-of-stock-message">
              üö´ Producto no disponible
            </div>
          {% else %}
            {% comment %}FORMULARIOS DE CARRITO - Solo si hay stock{% endcomment %}
            {% if it.origen == 'DB' and it.pk %}
              <form action="{% url 'cart:add_db' it.pk %}" method="post" class="cart-form" data-cart-form data-product-id="{{ it.pk }}">
                {% csrf_token %}
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                  <button type="button" class="qty-btn qty-minus">‚àí</button>
                  <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                  <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar al carrito</button>
              </form>
            {% elif it.match_id %}
              <form action="{% url 'cart:add_db' it.match_id %}" method="post" class="cart-form" data-cart-form data-product-id="{{ it.match_id }}">
                {% csrf_token %}
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                  <button type="button" class="qty-btn qty-minus">‚àí</button>
                  <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                  <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar al carrito</button>
              </form>
            {% else %}
              <form action="{% url 'cart:add' %}" method="post" class="cart-form" data-cart-form>
                {% csrf_token %}
                <input type="hidden" name="origin" value="X">
                <input type="hidden" name="product_id" value="{{ it.idx }}">
                <input type="hidden" name="name" value="{{ it.titulo }}">
                <input type="hidden" name="price" value="{{ it.precio }}">
                {# ‚ú® CORRECCI√ìN: Usar img_url en lugar de construir manualmente #}
                <input type="hidden" name="img" value="{{ it.img_url }}">
                <input type="hidden" name="replace" value="0">
                <div class="quantity-selector">
                  <button type="button" class="qty-btn qty-minus">‚àí</button>
                  <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
                  <button type="button" class="qty-btn qty-plus">+</button>
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar material</button>
              </form>
            {% endif %}
          {% endif %}
        </div>
      </article>
    {% empty %}
      <p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">{% trans "No hay sahumerios disponibles" %}</p>
    {% endfor %}
  </div>

  <script>
  (function() {
    'use strict';

    document.addEventListener('DOMContentLoaded', function() {
      const grid = document.querySelector('.products-grid');
      if (!grid) return;

      // Event delegation para botones de cantidad
      grid.addEventListener('click', function(e) {
        const qtyBtn = e.target.closest('.qty-minus, .qty-plus');
        if (!qtyBtn) return;

        const form = qtyBtn.closest('form');
        const input = form?.querySelector('.qty-input');
        if (!input) return;

        const current = parseInt(input.value, 10) || 1;
        const isPlus = qtyBtn.classList.contains('qty-plus');
        input.value = isPlus ? current + 1 : Math.max(1, current - 1);
      });

      // Event delegation para formularios de carrito
      grid.addEventListener('submit', async function(e) {
        const form = e.target.closest('form[data-cart-form]');
        if (!form) return;

        e.preventDefault();

        const button = form.querySelector('.add-to-cart-btn');
        if (!button) {
          form.submit();
          return;
        }

        const originalText = button.innerHTML;
        button.innerHTML = 'Agregando...';
        button.style.opacity = '0.6';
        button.disabled = true;

        try {
          const response = await fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });

          if (!response.ok) throw new Error('HTTP ' + response.status);

          document.dispatchEvent(new CustomEvent('cartUpdated'));
          button.innerHTML = '‚úì Agregado';
          button.style.background = 'var(--accent)';

        } catch (error) {
          console.error('Error:', error);
          button.innerHTML = '‚úó Error';
          button.style.background = '#d4756a';
        } finally {
          setTimeout(function() {
            button.innerHTML = originalText;
            button.style.opacity = '1';
            button.style.background = '';
            button.disabled = false;
          }, 1500);
        }
      });
    });
  })();
  </script>
{% endblock %}