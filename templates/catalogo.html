{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}Cat√°logo de Sahumerios - Fuego de Atenea{% endblock %}
{% block body_class %}page-catalog{% endblock %}

{% block styles %}
<style>
:root {
  --bg-primary: var(--mystic-cream);
  --bg-secondary: rgba(255,255,255,0.7);
  --bg-card: rgba(255,255,255,0.9);
  --bg-card-hover: rgba(255,255,255,1);
  --text-primary: var(--mystic-text);
  --text-secondary: color-mix(in srgb, var(--mystic-text) 80%, black 0%);
  --text-muted: rgba(61,55,49,0.7);
  --accent: var(--mystic-gold);
  --accent-hover: var(--mystic-gold-light);
  --border: rgba(201, 169, 97, 0.25);
  --border-hover: rgba(201, 169, 97, 0.45);
  --shadow-sm: 0 2px 8px rgba(201, 169, 97, 0.12);
  --shadow-md: 0 6px 18px rgba(201, 169, 97, 0.18);
  --shadow-lg: 0 10px 36px rgba(201, 169, 97, 0.22);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --transition-fast: 0.2s ease;
  --transition-normal: 0.25s ease;
  --transition-slow: 0.35s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

.page-catalog { 
  background: var(--bg-primary); 
  color: var(--text-primary); 
  line-height: 1.6; 
  min-height: 100vh;
}

/* --- Header --- */
.catalog-header { 
  text-align: center; 
  margin: 0 auto 48px; 
  max-width: 880px; 
  padding: 24px; 
}
.catalog-title { 
  font-size: clamp(2rem, 5vw, 3rem); 
  font-weight: 400; 
  color: var(--accent); 
  margin-bottom: 12px; 
  letter-spacing: -0.02em; 
}
.catalog-subtitle { 
  font-size: 1rem; 
  font-weight: 300; 
  color: var(--text-secondary); 
}

/* --- Buttons --- */
.page-catalog .btn { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px; 
  padding: 12px 24px; 
  font-size: 0.9rem; 
  font-weight: 500; 
  text-decoration: none; 
  border: 1px solid var(--border); 
  border-radius: var(--radius-sm); 
  background: transparent; 
  color: var(--text-primary); 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  letter-spacing: 0.02em; 
  white-space: nowrap;
}
.page-catalog .btn:hover { 
  background: var(--bg-card); 
  border-color: var(--accent); 
  color: var(--accent); 
  transform: translateY(-1px);
}
.page-catalog .btn-primary { 
  background: var(--accent); 
  color: #fff; 
  border-color: var(--accent); 
}
.page-catalog .btn-primary:hover { 
  background: var(--accent-hover); 
  border-color: var(--accent-hover); 
  box-shadow: 0 6px 16px rgba(201,169,97,0.28); 
}
.page-catalog .btn-danger { 
  border-color: #d4756a; 
  color: #d4756a; 
}
.page-catalog .btn-danger:hover { 
  background: #d4756a; 
  color: #fff; 
}

/* --- Grid & Cards --- */
.products-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 28px; 
  padding: 0 8px; 
  max-width: 1400px; 
  margin: 0 auto;
}

.product-card { 
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  border-radius: var(--radius-md); 
  transition: all var(--transition-normal); 
  position: relative; 
  overflow: hidden; 
  display: flex; 
  flex-direction: column;
  will-change: transform;
  animation: fadeIn 0.4s ease-out backwards;
}
.product-card:hover:not(.out-of-stock) { 
  border-color: var(--accent); 
  box-shadow: var(--shadow-md); 
  transform: translateY(-2px);
}

/* Sin stock */
.product-card.out-of-stock {
  opacity: 0.65;
  background: rgba(245, 245, 245, 0.8);
  border-color: rgba(150, 150, 150, 0.3);
}
.product-card.out-of-stock .product-image img {
  filter: grayscale(100%) brightness(1.2);
  opacity: 0.6;
}
.product-card.out-of-stock .product-title a,
.product-card.out-of-stock .current-price {
  color: var(--text-muted);
}
.product-card.out-of-stock .current-price {
  text-decoration: line-through;
}

/* --- Badges --- */
.product-badges { 
  position: absolute; 
  top: 12px; 
  left: 12px; 
  display: flex; 
  flex-direction: column; 
  gap: 8px; 
  z-index: 2; 
}
.badge { 
  padding: 6px 12px; 
  font-size: 0.7rem; 
  font-weight: 500; 
  text-transform: uppercase; 
  letter-spacing: 0.08em; 
  background: rgba(255,255,255,0.95); 
  color: var(--text-primary); 
  border: 1px solid var(--border); 
  backdrop-filter: blur(8px); 
  border-radius: 4px; 
}
.badge-best-seller { background: var(--accent); color: #fff; border-color: var(--accent); }
.badge-new { color: var(--accent); border-color: var(--accent); }
.badge-import { color: var(--text-secondary); border-color: var(--border-hover); }
.badge-out-of-stock { background: rgba(128,128,128,0.95); color: #fff; border-color: #808080; font-weight: 600; }

/* --- Image --- */
.product-image { 
  position: relative; 
  height: 300px; 
  background: var(--bg-secondary); 
  overflow: hidden; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  border-bottom: 1px solid var(--border); 
}
.product-image img { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; 
  padding: 28px; 
  transition: transform var(--transition-slow), opacity var(--transition-normal); 
}
.product-card:not(.out-of-stock):hover .product-image img { 
  transform: scale(1.03); 
}

/* --- Actions --- */
.product-actions { 
  position: absolute; 
  top: 12px; 
  right: 12px; 
  display: flex; 
  flex-direction: column; 
  gap: 8px; 
  opacity: 0; 
  transform: translateX(8px); 
  transition: all var(--transition-normal); 
  z-index: 3; 
}
.product-card:not(.out-of-stock):hover .product-actions { 
  opacity: 1; 
  transform: translateX(0); 
}
.action-btn { 
  width: 38px; 
  height: 38px; 
  border: 1px solid var(--border); 
  background: rgba(255,255,255,0.95); 
  color: var(--accent); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  backdrop-filter: blur(8px); 
  border-radius: var(--radius-sm); 
}
.action-btn:hover { 
  background: var(--bg-card-hover); 
  border-color: var(--accent); 
  transform: scale(1.1);
}

/* --- Info --- */
.product-info { 
  padding: 18px; 
  flex-grow: 1; 
  display: flex; 
  flex-direction: column; 
}
.product-title { 
  font-size: 1.05rem; 
  font-weight: 600; 
  color: var(--text-primary); 
  margin-bottom: 6px; 
  line-height: 1.3;
}
.product-title a { 
  color: inherit; 
  text-decoration: none; 
  transition: color var(--transition-fast);
}
.product-title a:hover { 
  color: var(--accent); 
}
.product-brand { 
  font-size: 0.8rem; 
  color: var(--text-muted); 
  margin-bottom: 10px; 
  font-weight: 500; 
  text-transform: uppercase; 
  letter-spacing: 0.05em; 
}
.product-description { 
  font-size: 0.9rem; 
  color: var(--text-secondary); 
  margin-bottom: 16px; 
  line-height: 1.5; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  display: -webkit-box; 
  -webkit-box-orient: vertical; 
  -webkit-line-clamp: 2; 
}

/* --- Price --- */
.product-price { 
  display: flex; 
  align-items: baseline; 
  gap: 12px; 
  margin-top: auto; 
  padding-top: 12px; 
  border-top: 1px solid var(--border); 
  margin-bottom: 12px; 
}
.current-price { 
  font-size: 1.4rem; 
  font-weight: 700; 
  color: var(--accent); 
}
.old-price { 
  font-size: 0.9rem; 
  color: var(--text-muted); 
  text-decoration: line-through; 
}
.discount-badge { 
  font-size: 0.75rem; 
  color: var(--text-secondary); 
  font-weight: 600; 
}

/* --- Quantity --- */
.quantity-selector { 
  display: flex; 
  align-items: center; 
  gap: 0; 
  margin-bottom: 12px; 
  border: 1px solid var(--border); 
  width: fit-content; 
  border-radius: var(--radius-sm); 
  overflow: hidden; 
}
.qty-btn { 
  width: 36px; 
  height: 36px; 
  border: none; 
  background: transparent; 
  color: var(--accent); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  font-size: 1rem; 
  user-select: none;
}
.qty-btn:hover { 
  background: var(--bg-card-hover); 
  color: var(--accent-hover); 
}
.qty-btn:active { transform: scale(0.95); }
.qty-btn:first-child { border-right: 1px solid var(--border); }
.qty-btn:last-child { border-left: 1px solid var(--border); }
.qty-input { 
  width: 52px; 
  height: 36px; 
  border: none; 
  background: transparent; 
  color: var(--text-primary); 
  text-align: center; 
  font-weight: 600; 
  font-size: 0.95rem; 
}
.qty-input:focus { outline: none; }

/* --- Messages --- */
.out-of-stock-message {
  text-align: center;
  padding: 14px;
  background: rgba(128,128,128,0.08);
  border: 1px solid rgba(128,128,128,0.2);
  border-radius: var(--radius-sm);
  color: #666;
  font-size: 0.9rem;
  font-weight: 600;
}

/* --- Edit Mode --- */
.edit-mode-banner { 
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  padding: 18px; 
  margin: 0 8px 28px; 
  max-width: 1400px; 
  margin-left: auto; 
  margin-right: auto; 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  flex-wrap: wrap; 
  gap: 12px; 
  border-radius: var(--radius-md);
}
.edit-mode-title { font-weight: 600; }
.edit-mode-helper {
  margin: 4px 0 0;
  font-size: 0.9rem;
  color: var(--text-secondary);
}
.edit-actions { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
}

/* --- Responsive --- */
@media (max-width: 768px) {
  .products-grid { grid-template-columns: 1fr; gap: 20px; padding: 0; }
  .catalog-header { padding: 20px; margin-bottom: 36px; }
  .product-image { height: 240px; }
  .edit-mode-banner { flex-direction: column; align-items: flex-start; }
  .edit-actions { width: 100%; }
  .edit-actions .btn { flex: 1; }
}
@media (max-width: 480px) {
  .product-image { height: 220px; }
  .product-info { padding: 16px; }
  .catalog-title { font-size: 1.75rem; }
}

/* --- Animations --- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@media (prefers-reduced-motion: reduce) {
  .product-card, .product-image img {
    animation: none !important;
    transition: none !important;
    transform: none !important;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
  <h1 class="catalog-title">Colecci√≥n de Sahumerios</h1>
  <p class="catalog-subtitle">Fragancias artesanales y ediciones especiales</p>
</div>

{% if edit_mode %}
<div class="edit-mode-banner">
  <div>
    <div class="edit-mode-title">Modo edici√≥n activado</div>
    <p class="edit-mode-helper">Pod√©s agregar, editar o eliminar productos</p>
  </div>
  <div class="edit-actions">
    <a href="{% url 'sahumerios_lista' %}" class="btn">Salir</a>
    <a href="{% url 'sahumerio_nuevo' %}" class="btn btn-primary">Crear producto</a>
  </div>
</div>
{% endif %}

<div class="products-grid">
  {% for it in items %}
    {% comment %}--- Check disponibilidad: sin usar with anidado ---{% endcomment %}
    {% if it.stock == 0 or it.stock == "0" or it.stock == None or it.stock == '' or it.activo|lower == "no" or it.activo == "0" or it.activo|lower == "false" %}
    
    <article class="product-card out-of-stock" 
             data-product-id="{{ it.pk|default:it.idx }}" 
             data-origin="{{ it.origen }}">
      
      {% comment %}--- URL ---{% endcomment %}
      {% if it.origen == 'DB' and it.pk %}
        {% url 'sahumerio_detalle' it.pk as detail_url %}
      {% elif it.match_id %}
        {% url 'sahumerio_detalle' it.match_id as detail_url %}
      {% else %}
        {% url 'excel_detalle' it.idx as detail_url %}
      {% endif %}

      {% comment %}--- Badges ---{% endcomment %}
      <div class="product-badges">
        <span class="badge badge-out-of-stock">Sin Stock</span>
      </div>

      {% comment %}--- Imagen ---{% endcomment %}
      <div class="product-image">
        <a href="{{ detail_url }}">
          <img src="{{ it.img_url }}" alt="{{ it.titulo }}" loading="lazy" decoding="async">
        </a>
      </div>

      {% comment %}--- Info ---{% endcomment %}
      <div class="product-info">
        <h3 class="product-title"><a href="{{ detail_url }}">{{ it.titulo }}</a></h3>
        {% if it.marca %}<p class="product-brand">{{ it.marca }}</p>{% endif %}
        {% if it.descripcion %}<p class="product-description">{{ it.descripcion }}</p>{% endif %}

        {% comment %}--- Precio ---{% endcomment %}
        <div class="product-price">
          <span class="current-price">$ {{ it.precio|floatformat:2|intcomma }}</span>
        </div>

        {% comment %}--- Edici√≥n ---{% endcomment %}
        {% if edit_mode %}
        <div class="edit-actions" style="margin-bottom:12px;gap:8px;flex-wrap:wrap;">
          {% if it.origen == 'DB' and it.pk %}
            <a href="{% url 'sahumerio_editar' it.pk %}?volver={{ request.get_full_path|urlencode }}" class="btn">Editar</a>
            <form method="post" action="{% url 'sahumerio_borrar' it.pk %}" 
                  onsubmit="return confirm('¬øBorrar este producto?')" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Borrar</button>
            </form>
          {% else %}
            <a href="{% url 'sahumerio_nuevo' %}?sug_marca={{ it.marca|urlencode }}&sug_nombre={{ it.titulo|urlencode }}&sug_descripcion={{ it.descripcion|urlencode }}&sug_precio={{ it.precio|urlencode }}&sug_imagen_url={{ it.img_abs|urlencode }}&sug_imagen_file={{ it.img_file|urlencode }}" 
               class="btn btn-primary">Crear en DB</a>
          {% endif %}
        </div>
        {% endif %}

        <div class="out-of-stock-message">üö´ Producto no disponible</div>
      </div>
    </article>
    
    {% else %}
    
    <article class="product-card" 
             data-product-id="{{ it.pk|default:it.idx }}" 
             data-origin="{{ it.origen }}">
      
      {% comment %}--- URL ---{% endcomment %}
      {% if it.origen == 'DB' and it.pk %}
        {% url 'sahumerio_detalle' it.pk as detail_url %}
      {% elif it.match_id %}
        {% url 'sahumerio_detalle' it.match_id as detail_url %}
      {% else %}
        {% url 'excel_detalle' it.idx as detail_url %}
      {% endif %}

      {% comment %}--- Badges ---{% endcomment %}
      <div class="product-badges">
        {% if forloop.counter <= 3 %}
          <span class="badge badge-best-seller">Favorito</span>
        {% endif %}
        {% if not it.match_id and it.origen != 'DB' %}
          <span class="badge badge-import">Destacado</span>
        {% endif %}
        {% if forloop.counter|divisibleby:5 %}
          <span class="badge badge-new">Nuevo</span>
        {% endif %}
      </div>

      {% comment %}--- Imagen ---{% endcomment %}
      <div class="product-image">
        <a href="{{ detail_url }}">
          <img src="{{ it.img_url }}" alt="{{ it.titulo }}" loading="lazy" decoding="async">
        </a>
        <div class="product-actions">
          <button class="action-btn" type="button" title="Vista r√°pida" aria-label="Vista r√°pida">üëÅÔ∏è</button>
          <button class="action-btn" type="button" title="Favorito" aria-label="Agregar a favoritos">‚ù§</button>
        </div>
      </div>

      {% comment %}--- Info ---{% endcomment %}
      <div class="product-info">
        <h3 class="product-title"><a href="{{ detail_url }}">{{ it.titulo }}</a></h3>
        {% if it.marca %}<p class="product-brand">{{ it.marca }}</p>{% endif %}
        {% if it.descripcion %}<p class="product-description">{{ it.descripcion }}</p>{% endif %}

        {% comment %}--- Precio ---{% endcomment %}
        <div class="product-price">
          <span class="current-price">$ {{ it.precio|floatformat:2|intcomma }}</span>
          {% if forloop.counter|divisibleby:4 %}
            <span class="old-price">$ {{ it.precio|add:500|floatformat:2|intcomma }}</span>
            <span class="discount-badge">-15%</span>
          {% endif %}
        </div>

        {% comment %}--- Edici√≥n ---{% endcomment %}
        {% if edit_mode %}
        <div class="edit-actions" style="margin-bottom:12px;gap:8px;flex-wrap:wrap;">
          {% if it.origen == 'DB' and it.pk %}
            <a href="{% url 'sahumerio_editar' it.pk %}?volver={{ request.get_full_path|urlencode }}" class="btn">Editar</a>
            <form method="post" action="{% url 'sahumerio_borrar' it.pk %}" 
                  onsubmit="return confirm('¬øBorrar este producto?')" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Borrar</button>
            </form>
          {% else %}
            <a href="{% url 'sahumerio_nuevo' %}?sug_marca={{ it.marca|urlencode }}&sug_nombre={{ it.titulo|urlencode }}&sug_descripcion={{ it.descripcion|urlencode }}&sug_precio={{ it.precio|urlencode }}&sug_imagen_url={{ it.img_abs|urlencode }}&sug_imagen_file={{ it.img_file|urlencode }}" 
               class="btn btn-primary">Crear en DB</a>
          {% endif %}
        </div>
        {% endif %}

        {% comment %}--- Carrito ---{% endcomment %}
        <form method="post" action="{% if it.origen == 'DB' and it.pk %}{% url 'cart:add_db' it.pk %}{% elif it.match_id %}{% url 'cart:add_db' it.match_id %}{% else %}{% url 'cart:add' %}{% endif %}" class="cart-form" data-cart-form>
          {% csrf_token %}
          {% if not it.origen == 'DB' and not it.match_id %}
            <input type="hidden" name="origin" value="X">
            <input type="hidden" name="product_id" value="{{ it.idx }}">
            <input type="hidden" name="marca" value="{{ it.marca }}">
            <input type="hidden" name="name" value="{{ it.titulo }}">
            <input type="hidden" name="price" value="{{ it.precio }}">
            <input type="hidden" name="img" value="{{ it.img_url }}">
          {% endif %}
          <input type="hidden" name="replace" value="0">

          <div class="quantity-selector">
            <button type="button" class="qty-btn qty-minus" aria-label="Restar cantidad">‚àí</button>
            <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
            <button type="button" class="qty-btn qty-plus" aria-label="Sumar cantidad">+</button>
          </div>
          <button type="submit" class="btn btn-primary add-to-cart-btn">Agregar al carrito</button>
        </form>
      </div>
    </article>
    
    {% endif %}
  {% empty %}
    <p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">
      {% trans "No hay sahumerios disponibles" %}
    </p>
  {% endfor %}
</div>

<script>
(function() {
  'use strict';
  let isProcessing = false;

  document.addEventListener('DOMContentLoaded', () => {
    const grid = document.querySelector('.products-grid');
    if (!grid) return;

    // Controles de cantidad
    grid.addEventListener('click', (e) => {
      const btn = e.target.closest('.qty-minus, .qty-plus');
      if (!btn) return;
      const input = btn.closest('form')?.querySelector('.qty-input');
      if (!input) return;

      let val = parseInt(input.value) || 1;
      input.value = btn.classList.contains('qty-plus') ? val + 1 : Math.max(1, val - 1);
      btn.style.transform = 'scale(0.9)';
      setTimeout(() => btn.style.transform = '', 100);
    });

    // Env√≠o de formulario
    grid.addEventListener('submit', async (e) => {
      const form = e.target;
      if (!form.hasAttribute('data-cart-form') || isProcessing) return;

      e.preventDefault();
      const btn = form.querySelector('.add-to-cart-btn');
      if (!btn) return form.submit();

      isProcessing = true;
      const original = btn.innerHTML;
      btn.innerHTML = '‚è≥ Agregando...';
      btn.disabled = true;
      btn.style.opacity = '0.7';

      try {
        const response = await fetch(form.action, {
          method: 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });

        if (response.ok) {
          btn.innerHTML = '‚úì Agregado';
          btn.style.background = 'var(--accent)';
          btn.style.color = '#fff';
          form.querySelector('.qty-input').value = '1';
          document.dispatchEvent(new CustomEvent('cartUpdated'));
        } else {
          throw new Error('Error del servidor');
        }
      } catch (err) {
        alert('No se pudo agregar el producto. Intent√° nuevamente.');
        btn.innerHTML = original;
      } finally {
        isProcessing = false;
        btn.disabled = false;
        btn.style.opacity = '';
      }
    });

    // Animaci√≥n escalable
    document.querySelectorAll('.product-card').forEach((card, i) => {
      card.style.animationDelay = `${0.05 * (i % 20)}s`;
    });
  });
})();
</script>
{% endblock %}