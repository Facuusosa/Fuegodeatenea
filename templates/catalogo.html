<!-- templates/catalogo.html -->

{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}Colecci√≥n de Sahumerios - Fuego de Atenea{% endblock %}
{% block body_class %}page-catalog{% endblock %}

{% block styles %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=Inter:wght@400;500;600&display=swap');

:root {
  --bg-primary: var(--mystic-cream);
  --bg-secondary: rgba(255,255,255,0.7);
  --bg-card: rgba(255,255,255,0.9);
  --bg-card-hover: rgba(255,255,255,1);
  --text-primary: var(--mystic-text);
  --text-secondary: color-mix(in srgb, var(--mystic-text) 80%, black 0%);
  --text-muted: rgba(61,55,49,0.7);
  --accent: var(--mystic-gold);
  --accent-hover: var(--mystic-gold-light);
  --border: rgba(201, 169, 97, 0.25);
  --border-hover: rgba(201, 169, 97, 0.45);
  --shadow-sm: 0 2px 8px rgba(201, 169, 97, 0.12);
  --shadow-md: 0 6px 18px rgba(201, 169, 97, 0.18);
  --shadow-lg: 0 10px 36px rgba(201, 169, 97, 0.22);
  --radius-sm: 6px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --transition-fast: 0.2s ease;
  --transition-normal: 0.25s ease;
  --transition-slow: 0.35s ease;
}

* { 
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}

.page-catalog { 
  background: var(--bg-primary); 
  color: var(--text-primary); 
  line-height: 1.6; 
  min-height: 100vh; 
}

.catalog-header { 
  text-align: center; 
  margin: 0 auto 48px; 
  max-width: 880px; 
  padding: 24px; 
}

.catalog-title { 
  font-size: clamp(2rem, 5vw, 3rem); 
  font-weight: 400; 
  color: var(--accent); 
  margin-bottom: 12px; 
  letter-spacing: -0.02em; 
}

.catalog-subtitle { 
  font-size: 1rem; 
  font-weight: 300; 
  color: var(--text-secondary); 
}

.filters-container { 
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  border-radius: var(--radius-md); 
  padding: 24px; 
  margin: 0 auto 48px; 
  max-width: 1400px; 
  box-shadow: var(--shadow-sm); 
}

.filters-title { 
  font-size: 1rem; 
  font-weight: 500; 
  color: var(--text-primary); 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  margin-bottom: 20px; 
  letter-spacing: 0.02em; 
}

.filters-form { 
  display: grid; 
  grid-template-columns: 2fr 2fr 1fr; 
  gap: 16px; 
  align-items: end; 
}

.filter-group { 
  display: flex; 
  flex-direction: column; 
  gap: 8px; 
}

.filter-label { 
  font-size: 0.8rem; 
  font-weight: 500; 
  color: var(--text-secondary); 
  text-transform: uppercase; 
  letter-spacing: 0.08em; 
}

.filter-select, 
.filter-input { 
  padding: 12px 14px; 
  border: 1px solid var(--border); 
  border-radius: 6px; 
  background: white; 
  font-size: 0.95rem; 
  font-family: inherit; 
  transition: all 0.2s; 
  color: var(--text-primary); 
}

.filter-select:focus, 
.filter-input:focus { 
  outline: none; 
  border-color: var(--accent); 
  box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1); 
}

.filter-actions { 
  display: flex; 
  gap: 12px; 
}

.filter-btn { 
  padding: 12px 24px; 
  border: 1px solid var(--accent); 
  background: var(--accent); 
  color: white; 
  font-size: 0.85rem; 
  font-weight: 500; 
  border-radius: 6px; 
  cursor: pointer; 
  text-transform: uppercase; 
  letter-spacing: 0.05em; 
  transition: all 0.2s; 
}

.filter-btn:hover { 
  background: var(--accent-hover); 
  border-color: var(--accent-hover); 
}

.filter-btn-clear { 
  background: white; 
  color: var(--text-primary); 
  border-color: var(--border); 
  text-decoration: none; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
}

.filter-btn-clear:hover { 
  background: var(--bg-primary); 
  border-color: var(--text-secondary); 
}

.results-count { 
  text-align: center; 
  margin-bottom: 40px; 
  color: var(--text-secondary); 
  font-size: 0.9rem; 
  font-weight: 400; 
  letter-spacing: 0.02em; 
}

.products-grid { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
  gap: 28px; 
  padding: 0 8px; 
  max-width: 1400px; 
  margin: 0 auto; 
}

.product-card { 
  background: var(--bg-card); 
  border: 1px solid var(--border); 
  border-radius: var(--radius-md); 
  transition: all var(--transition-normal); 
  position: relative; 
  overflow: hidden; 
  display: flex; 
  flex-direction: column; 
  will-change: transform; 
  animation: fadeIn 0.4s ease-out backwards; 
}

.product-card:hover:not(.out-of-stock) { 
  border-color: var(--accent); 
  box-shadow: var(--shadow-md); 
  transform: translateY(-2px); 
}

.product-card.out-of-stock { 
  opacity: 0.65; 
  background: rgba(245, 245, 245, 0.8); 
  border-color: rgba(150, 150, 150, 0.3); 
}

.product-card.out-of-stock .product-image img { 
  filter: grayscale(100%) brightness(1.2); 
  opacity: 0.6; 
}

.product-card.out-of-stock .product-title a, 
.product-card.out-of-stock .current-price { 
  color: var(--text-muted); 
}

.product-card.out-of-stock .current-price { 
  text-decoration: line-through; 
}

.product-badges { 
  position: absolute; 
  top: 12px; 
  left: 12px; 
  display: flex; 
  flex-direction: column; 
  gap: 8px; 
  z-index: 2; 
}

.badge { 
  padding: 6px 12px; 
  font-size: 0.7rem; 
  font-weight: 500; 
  text-transform: uppercase; 
  letter-spacing: 0.08em; 
  background: rgba(255,255,255,0.95); 
  color: var(--text-primary); 
  border: 1px solid var(--border); 
  backdrop-filter: blur(8px); 
  border-radius: 4px; 
}

.badge-best-seller { 
  background: var(--accent); 
  color: #fff; 
  border-color: var(--accent); 
}

.badge-new { 
  color: var(--accent); 
  border-color: var(--accent); 
}

.badge-import { 
  color: var(--text-secondary); 
  border-color: var(--border-hover); 
}

.product-image { 
  position: relative; 
  height: 300px; 
  background: var(--bg-secondary); 
  overflow: hidden; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  border-bottom: 1px solid var(--border); 
}

.product-image img { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; 
  padding: 28px; 
  transition: transform var(--transition-slow); 
}

.product-card:not(.out-of-stock):hover .product-image img { 
  transform: scale(1.03); 
}

.product-actions { 
  position: absolute; 
  top: 12px; 
  right: 12px; 
  display: flex; 
  flex-direction: column; 
  gap: 8px; 
  opacity: 0; 
  transform: translateX(8px); 
  transition: all var(--transition-normal); 
  z-index: 3; 
}

.product-card:not(.out-of-stock):hover .product-actions { 
  opacity: 1; 
  transform: translateX(0); 
}

.action-btn { 
  width: 38px; 
  height: 38px; 
  border: 1px solid var(--border); 
  background: rgba(255,255,255,0.95); 
  color: var(--accent); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  backdrop-filter: blur(8px); 
  border-radius: var(--radius-sm); 
}

.action-btn:hover { 
  background: var(--bg-card-hover); 
  border-color: var(--accent); 
  transform: scale(1.1); 
}

.product-info { 
  padding: 18px; 
  flex-grow: 1; 
  display: flex; 
  flex-direction: column; 
}

.product-title { 
  font-size: 1.05rem; 
  font-weight: 600; 
  color: var(--text-primary); 
  margin-bottom: 6px; 
  line-height: 1.3; 
}

.product-title a { 
  color: inherit; 
  text-decoration: none; 
  transition: color var(--transition-fast); 
}

.product-title a:hover { 
  color: var(--accent); 
}

.product-brand { 
  font-size: 0.8rem; 
  color: var(--text-muted); 
  margin-bottom: 10px; 
  font-weight: 500; 
  text-transform: uppercase; 
  letter-spacing: 0.05em; 
}

.product-description { 
  font-size: 0.9rem; 
  color: var(--text-secondary); 
  margin-bottom: 12px; 
  line-height: 1.5; 
}

.product-price { 
  font-size: 1.25rem; 
  font-weight: 600; 
  color: var(--text-primary); 
  margin-top: auto; 
  margin-bottom: 16px; 
  letter-spacing: -0.01em; 
}

.quantity-selector { 
  display: flex; 
  align-items: center; 
  gap: 0; 
  margin-bottom: 12px; 
  border: 1px solid var(--border); 
  width: fit-content; 
  border-radius: var(--radius-sm); 
  overflow: hidden; 
}

.qty-btn { 
  width: 36px; 
  height: 36px; 
  border: none; 
  background: transparent; 
  color: var(--accent); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  font-size: 1rem; 
  user-select: none; 
}

.qty-btn:hover:not(:disabled) { 
  background: var(--bg-card-hover); 
  color: var(--accent-hover); 
}

.qty-btn:active:not(:disabled) { 
  transform: scale(0.95); 
}

.qty-btn:disabled { 
  opacity: 0.4; 
  cursor: not-allowed; 
}

.qty-btn:first-child { 
  border-right: 1px solid var(--border); 
}

.qty-btn:last-child { 
  border-left: 1px solid var(--border); 
}

.qty-input { 
  width: 52px; 
  height: 36px; 
  border: none; 
  background: transparent; 
  color: var(--text-primary); 
  text-align: center; 
  font-weight: 600; 
  font-size: 0.95rem; 
}

.qty-input:focus { 
  outline: none; 
}

.page-catalog .btn { 
  display: inline-flex; 
  align-items: center; 
  justify-content: center; 
  gap: 8px; 
  padding: 12px 24px; 
  font-size: 0.9rem; 
  font-weight: 500; 
  text-decoration: none; 
  border: 1px solid var(--border); 
  border-radius: var(--radius-sm); 
  background: transparent; 
  color: var(--text-primary); 
  cursor: pointer; 
  transition: all var(--transition-fast); 
  letter-spacing: 0.02em; 
  white-space: nowrap; 
}

.page-catalog .btn:hover { 
  background: var(--bg-card); 
  border-color: var(--accent); 
  color: var(--accent); 
  transform: translateY(-1px); 
}

.page-catalog .btn-primary { 
  background: var(--accent); 
  color: #fff; 
  border-color: var(--accent); 
  width: 100%; 
}

.page-catalog .btn-primary:hover:not(:disabled) { 
  background: var(--accent-hover); 
  border-color: var(--accent-hover); 
  box-shadow: 0 6px 16px rgba(201,169,97,0.28); 
}

.page-catalog .btn-primary:disabled { 
  opacity: 0.6; 
  cursor: not-allowed; 
  transform: none; 
}

.no-results-message { 
  text-align: center; 
  padding: 80px 20px; 
  grid-column: 1 / -1; 
}

.no-results-message h3 { 
  font-family: 'Cormorant Garamond', serif; 
  font-size: 1.8rem; 
  font-weight: 400; 
  color: var(--text-primary); 
  margin-bottom: 12px; 
}

.no-results-message p { 
  color: var(--text-secondary); 
  font-size: 1rem; 
  margin-bottom: 24px; 
}

@keyframes fadeIn { 
  from { 
    opacity: 0; 
    transform: translateY(10px); 
  } 
  to { 
    opacity: 1; 
    transform: translateY(0); 
  } 
}

@media (max-width: 1024px) { 
  .products-grid { 
    grid-template-columns: repeat(2, 1fr); 
    gap: 24px; 
  } 
}

@media (max-width: 992px) { 
  .filters-form { 
    grid-template-columns: 1fr; 
  } 
  
  .filter-btn { 
    flex: 1; 
  } 
}

@media (max-width: 768px) { 
  .page-catalog { 
    padding: 40px 16px; 
  } 
  
  .products-grid { 
    grid-template-columns: 1fr; 
    gap: 24px; 
  } 
  
  .product-image { 
    height: 300px; 
  } 
  
  .catalog-header { 
    margin-bottom: 40px; 
  } 
}

@media (max-width: 480px) { 
  .catalog-title { 
    font-size: 2rem; 
  } 
  
  .filter-actions { 
    flex-direction: column; 
  } 
  
  .filter-btn { 
    width: 100%; 
  } 
}
</style>
{% endblock %}

{% block content %}
<div class="catalog-header">
  <h1 class="catalog-title">Colecci√≥n de Sahumerios</h1>
  <p class="catalog-subtitle">Fragancias artesanales y ediciones especiales</p>
</div>

<div class="filters-container">
  <h2 class="filters-title">üîç Filtrar productos</h2>
  <form method="get" action="" class="filters-form">
    <div class="filter-group">
      <label class="filter-label">Buscar</label>
      <input type="text" name="search" class="filter-input" placeholder="Buscar por nombre o marca..." value="{{ search }}">
    </div>
    <div class="filter-group">
      <label class="filter-label">Marca</label>
      <select name="marca" class="filter-select">
        <option value="">Todas las marcas</option>
        {% for m in marcas %}
          <option value="{{ m }}" {% if marca_activa == m %}selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="filter-actions">
      <button type="submit" class="filter-btn">Buscar</button>
      <a href="{% url 'sahumerios_lista' %}" class="filter-btn filter-btn-clear">Limpiar</a>
    </div>
  </form>
</div>

<p class="results-count">Mostrando <strong>{{ items|length }}</strong> productos</p>

<div class="products-grid">
  {% if items %}
    {% for item in items %}
      {% if item.stock > 0 or item.activo %}
      <div class="product-card {% if item.stock <= 0 %}out-of-stock{% endif %}">
        <div class="product-badges">
          {% if forloop.counter <= 3 %}<span class="badge badge-best-seller">Favorito</span>{% endif %}
          {% if not item.match_id and item.origen != 'DB' %}<span class="badge badge-import">Destacado</span>{% endif %}
          {% if forloop.counter|divisibleby:5 %}<span class="badge badge-new">Nuevo</span>{% endif %}
        </div>
        <div class="product-image">
          <a href="{% if item.pk %}{% url 'sahumerio_detalle' item.pk %}{% else %}{% url 'excel_detalle' item.idx %}{% endif %}">
            <img src="{{ item.img_url }}" alt="{{ item.titulo }}" loading="lazy" decoding="async">
          </a>
          <div class="product-actions">
            <button class="action-btn" type="button" title="Vista r√°pida" aria-label="Vista r√°pida">üëÅÔ∏è</button>
            <button class="action-btn" type="button" title="Favorito" aria-label="Agregar a favoritos">‚ù§</button>
          </div>
        </div>
        <div class="product-info">
          <h3 class="product-title">
            <a href="{% if item.pk %}{% url 'sahumerio_detalle' item.pk %}{% else %}{% url 'excel_detalle' item.idx %}{% endif %}">
              {{ item.titulo }}
            </a>
          </h3>
          {% if item.marca %}<p class="product-brand">{{ item.marca }}</p>{% endif %}
          {% if item.descripcion %}<p class="product-description">{{ item.descripcion }}</p>{% endif %}
          <div class="product-price">
            <span class="current-price">$ {{ item.precio|floatformat:2|intcomma }}</span>
          </div>
          <form method="post" action="{% if item.origen == 'DB' and item.pk %}{% url 'cart:add_db' item.pk %}{% elif item.match_id %}{% url 'cart:add_db' item.match_id %}{% else %}{% url 'cart:add' %}{% endif %}" class="cart-form" data-cart-form>
            {% csrf_token %}
            {% if not item.origen == 'DB' and not item.match_id %}
              <input type="hidden" name="origin" value="X">
              <input type="hidden" name="product_id" value="{{ item.idx }}">
              <input type="hidden" name="marca" value="{{ item.marca }}">
              <input type="hidden" name="name" value="{{ item.titulo }}">
              <input type="hidden" name="price" value="{{ item.precio }}">
              <input type="hidden" name="img" value="{{ item.img_url }}">
            {% endif %}
            <input type="hidden" name="replace" value="0">
            <input type="hidden" name="stock" value="{{ item.stock }}" class="stock-hidden">
            <div class="quantity-selector">
              <button type="button" class="qty-btn qty-minus" aria-label="Restar cantidad">‚àí</button>
              <input type="number" name="quantity" value="1" min="1" class="qty-input" required>
              <button type="button" class="qty-btn qty-plus" aria-label="Sumar cantidad">+</button>
            </div>
            <button type="submit" class="btn btn-primary add-to-cart-btn" {% if item.stock <= 0 %}disabled{% endif %}>
              Agregar al carrito
            </button>
          </form>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="no-results-message">
      <h3>No se encontraron productos</h3>
      <p>Intenta con otra b√∫squeda o marca</p>
      <a href="{% url 'sahumerios_lista' %}" class="filter-btn">Ver todos los productos</a>
    </div>
  {% endif %}
</div>

<script>
(function() {
  'use strict';
  
  // Variables globales para el estado del carrito
  let isSubmitting = false;
  const clickDebounceMap = new WeakMap();
  const DEBOUNCE_DELAY = 100;
  
  /**
   * Actualiza el estado de los botones de cantidad seg√∫n el valor actual
   */
  function updateButtonStates(form) {
    const input = form.querySelector('.qty-input');
    const minusBtn = form.querySelector('.qty-minus');
    const plusBtn = form.querySelector('.qty-plus');
    
    if (!input || !minusBtn || !plusBtn) return;
    
    const currentValue = parseInt(input.value) || 1;
    
    // Deshabilitar bot√≥n menos solo si est√° en el m√≠nimo
    minusBtn.disabled = currentValue <= 1;
    
    // El bot√≥n m√°s siempre habilitado - sin l√≠mite de cantidad
    plusBtn.disabled = false;
  }
  
  /**
   * Maneja los clicks en los botones de cantidad (+/-)
   */
  function handleQuantityButtonClick(event) {
    const button = event.target.closest('.qty-minus, .qty-plus');
    
    // Si no es un bot√≥n de cantidad o est√° deshabilitado, salir
    if (!button || button.disabled) return;
    
    // Prevenir clicks m√∫ltiples r√°pidos (debounce)
    const now = Date.now();
    const lastClick = clickDebounceMap.get(button) || 0;
    if (now - lastClick < DEBOUNCE_DELAY) return;
    clickDebounceMap.set(button, now);
    
    // Encontrar el formulario y el input
    const form = button.closest('.cart-form');
    if (!form) return;
    
    const input = form.querySelector('.qty-input');
    if (!input || input.disabled) return;
    
    // Obtener valor actual
    let currentValue = parseInt(input.value) || 1;
    
    // Determinar si es incremento o decremento
    const isPlus = button.classList.contains('qty-plus');
    
    if (isPlus) {
      // Incrementar sin l√≠mite
      currentValue++;
    } else {
      // Decrementar solo si es mayor a 1
      if (currentValue > 1) {
        currentValue--;
      }
    }
    
    // Actualizar el valor del input
    input.value = currentValue;
    
    // Actualizar estado de los botones
    updateButtonStates(form);
    
    // Animaci√≥n visual del bot√≥n
    button.style.transform = 'scale(0.9)';
    requestAnimationFrame(() => {
      setTimeout(() => {
        button.style.transform = '';
      }, 80);
    });
  }
  
  /**
   * Maneja cambios en el input de cantidad (escritura manual)
   */
  function handleQuantityInputChange(event) {
    const input = event.target;
    if (!input.classList.contains('qty-input')) return;
    
    const form = input.closest('.cart-form');
    if (!form) return;
    
    let value = parseInt(input.value);
    
    // Validar que sea un n√∫mero v√°lido y mayor a 0
    if (isNaN(value) || value < 1) {
      input.value = 1;
      value = 1;
    }
    
    // Sin l√≠mite m√°ximo - puedes agregar la cantidad que quieras
    
    // Actualizar estado de los botones
    updateButtonStates(form);
  }
  
  /**
   * Maneja el env√≠o del formulario al carrito
   */
  async function handleFormSubmit(event) {
    const form = event.target;
    
    // Solo procesar si es un formulario del carrito
    if (!form.hasAttribute('data-cart-form')) return;
    
    event.preventDefault();
    
    // Prevenir env√≠os m√∫ltiples simult√°neos
    if (isSubmitting || form.dataset.submitting === 'true') {
      return;
    }
    
    const submitButton = form.querySelector('.add-to-cart-btn');
    if (!submitButton || submitButton.disabled) return;
    
    const quantityInput = form.querySelector('.qty-input');
    const quantity = parseInt(quantityInput.value) || 1;
    const stockInput = form.querySelector('.stock-hidden');
    const stock = stockInput ? parseInt(stockInput.value) || 0 : 0;
    
    // Solo validar que la cantidad sea v√°lida (mayor a 0)
    // El stock es solo informativo, no limitante
    if (quantity < 1) {
      alert('La cantidad debe ser al menos 1.');
      quantityInput.value = 1;
      return;
    }
    
    // Marcar como enviando
    isSubmitting = true;
    form.dataset.submitting = 'true';
    
    // Guardar texto original del bot√≥n
    const originalButtonText = submitButton.innerHTML;
    submitButton.innerHTML = '‚è≥ Agregando...';
    submitButton.disabled = true;
    submitButton.style.opacity = '0.7';
    
    try {
      // Enviar formulario por AJAX
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });
      
      if (response.ok) {
        const data = await response.json().catch(() => ({}));
        
        if (data.success !== false) {
          // √âxito al agregar al carrito
          submitButton.innerHTML = '‚úì Agregado';
          submitButton.style.background = 'var(--accent)';
          submitButton.style.color = '#fff';
          
          // Resetear cantidad a 1
          quantityInput.value = '1';
          updateButtonStates(form);
          
          // Actualizar contador del carrito en el header
          const cartCount = document.getElementById('cartCount');
          if (cartCount && data.cart_total !== undefined) {
            cartCount.textContent = data.cart_total;
            if (data.cart_total > 0) {
              cartCount.classList.remove('hidden');
            }
          }
          
          // Disparar evento personalizado para otros listeners
          document.dispatchEvent(new CustomEvent('cartUpdated', { 
            detail: data 
          }));
          
          // Restaurar bot√≥n despu√©s de 2 segundos
          setTimeout(() => {
            submitButton.innerHTML = originalButtonText;
            submitButton.style.background = '';
            submitButton.style.color = '';
          }, 2000);
        } else {
          throw new Error(data.message || 'Error al agregar producto');
        }
      } else {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.message || `Error del servidor (${response.status})`);
      }
    } catch (error) {
      console.error('Error al agregar al carrito:', error);
      alert(error.message || 'No se pudo agregar el producto. Intent√° nuevamente.');
      
      submitButton.innerHTML = originalButtonText;
      submitButton.style.background = '';
      submitButton.style.color = '';
    } finally {
      // Limpiar estado de env√≠o
      isSubmitting = false;
      delete form.dataset.submitting;
      submitButton.disabled = false;
      submitButton.style.opacity = '';
    }
  }
  
  /**
   * Inicializaci√≥n cuando el DOM est√° listo
   */
  document.addEventListener('DOMContentLoaded', () => {
    const productsGrid = document.querySelector('.products-grid');
    if (!productsGrid) return;
    
    // Event delegation para clicks en botones de cantidad
    productsGrid.addEventListener('click', handleQuantityButtonClick);
    
    // Event delegation para cambios en inputs de cantidad
    productsGrid.addEventListener('input', handleQuantityInputChange);
    
    // Event delegation para env√≠o de formularios
    productsGrid.addEventListener('submit', handleFormSubmit);
    
    // Animaci√≥n de aparici√≥n progresiva con Intersection Observer
    if ('IntersectionObserver' in window) {
      const productCards = document.querySelectorAll('.product-card');
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
          }
        });
      }, {
        threshold: 0.1,
        rootMargin: '50px'
      });
      
      productCards.forEach((card, index) => {
        card.style.animationDelay = `${(index % 20) * 0.05}s`;
        card.style.opacity = '0';
        observer.observe(card);
      });
    } else {
      // Fallback para navegadores antiguos sin Intersection Observer
      document.querySelectorAll('.product-card').forEach((card, index) => {
        card.style.animationDelay = `${(index % 20) * 0.05}s`;
      });
    }
    
    // Inicializar el estado de todos los botones de cantidad al cargar
    document.querySelectorAll('.cart-form').forEach(form => {
      const input = form.querySelector('.qty-input');
      if (input) {
        // Disparar evento input para inicializar
        input.dispatchEvent(new Event('input'));
      }
    });
  });
})();
</script>
{% endblock %}